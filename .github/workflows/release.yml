name: Release Build and Publish

on:
  push:
    tags:
      - 'v*'  # 匹配 v 开头的标签，如 v1.0.0, v2.1.0

env:
  APP_NAME: goenv-switch
  GO_VERSION: '1.23.3'

permissions:
  contents: write  # 授予写入内容的权限（包括创建 Release、上传资产）
  packages: write  # 上传包到 GitHub Packages

jobs:
  # 代码质量检查和测试
  quality:
    name: Code Quality and Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install dependencies
      run: make deps

    - name: Code formatting check
      run: make fmt-check

    - name: Static analysis
      run: make vet

    - name: Run tests
      run: make test-race

  # 多平台构建和发布
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Get version from tag
      id: get_version
      run: |
        # 从标签中提取版本号（移除 v 前缀）
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Install dependencies
      run: make deps

    - name: Build for all platforms
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        make build-all VERSION=$VERSION

    - name: Package release files
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        make package VERSION=$VERSION

    - name: Generate checksums
      run: make checksum

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ env.APP_NAME }} ${{ steps.get_version.outputs.version }}
        body: |
          ## GoEnv-Switch ${{ steps.get_version.outputs.version }}
          
          一个专业的 Go 语言环境配置切换工具，支持通过配置文件管理多个环境配置。
          
          ### 下载
          请根据您的操作系统选择合适的版本下载：
          
          - **Linux x64**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_linux_amd64.tar.gz`
          - **Linux ARM64**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_linux_arm64.tar.gz`
          - **Linux 386**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_linux_386.tar.gz`
          - **macOS x64**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_darwin_amd64.tar.gz`
          - **macOS ARM64**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_darwin_arm64.tar.gz`
          - **Windows x64**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_windows_amd64.zip`
          - **Windows 386**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_windows_386.zip`
          - **Windows ARM64**: `${{ env.APP_NAME }}_${{ steps.get_version.outputs.version }}_windows_arm64.zip`
          
          ### 校验和
          下载后请验证文件的 SHA256 校验和以确保文件完整性。
          
          ### 使用说明
          详细使用说明请参考 [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ### 变更日志
          - 自动构建版本 ${{ steps.get_version.outputs.version }}
          - 支持多平台二进制文件
          - 包含配置文件模板
        draft: false
        prerelease: false
        files: |
          dist/*.tar.gz
          dist/*.zip
          dist/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 快速发布（可选，跳过测试）
  quick-release:
    name: Quick Release (Skip Tests)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # 手动触发
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Quick release build
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        make quick-release VERSION=$VERSION

    - name: Create Quick Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ env.APP_NAME }} ${{ steps.get_version.outputs.version }} (Quick)
        body: |
          ## GoEnv-Switch ${{ steps.get_version.outputs.version }} (快速发布)
          
          此版本为快速发布版本，跳过了部分测试流程。
          
          ### 下载
          请根据您的操作系统选择合适的版本下载。
          
          ### 校验和
          下载后请验证文件的 SHA256 校验和以确保文件完整性。
        draft: false
        prerelease: true
        files: |
          dist/*.tar.gz
          dist/*.zip
          dist/checksums.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}